# HTMDv2.2s CAN通信プロトコル <!-- omit in toc -->
## HTMDv2.2sにおけるCAN通信のメッセージ一覧 <!-- omit in toc -->
- [MD受信メッセージ](#md受信メッセージ)
  - [`Init_with_conf` メッセージドキュメント](#init_with_conf-メッセージドキュメント)
    - [概要](#概要)
    - [メッセージID](#メッセージid)
    - [メッセージ構造](#メッセージ構造)
    - [フィールド定義](#フィールド定義)
    - [応答メッセージ](#応答メッセージ)
  - [`MotorDrive` メッセージドキュメント](#motordrive-メッセージドキュメント)
    - [概要](#概要-1)
    - [メッセージID](#メッセージid-1)
    - [メッセージ構造](#メッセージ構造-1)
    - [フィールド定義](#フィールド定義-1)
  - [`StatusRequest` メッセージドキュメント](#statusrequest-メッセージドキュメント)
    - [概要](#概要-2)
    - [メッセージID](#メッセージid-2)
    - [メッセージ構造](#メッセージ構造-2)
    - [応答メッセージ](#応答メッセージ-1)
- [MD送信メッセージ](#md送信メッセージ)
  - [`StatusResponse` メッセージドキュメント](#statusresponse-メッセージドキュメント)
    - [概要](#概要-3)
    - [メッセージID](#メッセージid-3)
    - [メッセージ構造](#メッセージ構造-3)
    - [フィールド定義](#フィールド定義-2)


# MD受信メッセージ
## `Init_with_conf` メッセージドキュメント

### 概要

`Init_with_conf`は、モータードライバの初期化と設定情報を一度に伝えるためのメッセージです。<br>
このメッセージは最初に送信してください。<br>
初期化後にこのメッセージを再送した場合、ACKは帰ってきますが設定した`config_flags`は更新されません。これは一度メイン基板側の電源を落としてもロジック部の電源を全て落とす必要がないことを示します。<br>
MDは状態がERRの時以外はこのメッセージを受信してACKもしくは状態に依存したメッセージを返します。

### メッセージID

- **CAN ID**: `0x010`

### メッセージ構造

```c
typedef struct {
    uint8_t md_id;           // モータードライバID
    uint8_t config_flags;    // エンコーダの種類と過電流検知の設定情報
    uint8_t data_send_cycle; // モータードライバからのデータ送信周期
} Init_with_conf;
```

### フィールド定義

1. **md_id (1バイト)**
    - モータードライバの固有ID。
    - 範囲: `0x00` ～ `0xFF`

2. **config_flags (1バイト)**
    - エンコーダの種類と過電流検知の設定情報を格納するビット列。

    ```plaintext
    |   bit 7-5  |  bit 4  |   bit 3  |  bit 2  |  bit 1-0 |
    |------------|---------|----------|---------|----------|
    |    RSV     |    HB   |   OCD2   |   OCD1  |    ENC   |
    ```

    - **RSV**:予約済みbit<br>
    現在のバージョンでは使用されていませんが、将来のために確保されているスペースです。<br>
    通常、ゼロにセットされることを推奨します。
    - **HB**: ハートビート通信の設定
    ```plaintext
    | 0 |ハートビート通信を行う
    | 1 |ハートビート通信を行わない
    ```
    2023/10/10現在ハートビート通信は未実装です。行う設定にしてもハートビート通信は無視されます。
    - **ENC[1:0]**: エンコーダの種類を設定するbit

    ```plaintext
    | 0 |エンコーダを使用しない
    | 1 |インクリメンタルエンコーダ
    | 2 |アブソリュートエンコーダ
    ```
    2023/10/10時点でアブソエンコーダは未実装です。アブソエンコーダを指定した場合は使用しない設定とみなされます。
    - **OCD1**: 過電流検知1の使用設定
    - **OCD2**: 過電流検知2の使用設定
    ```plaintext
    | 0 |過電流検知時にモーターを停止する(推奨)
    | 1 |過電流検知時にモーターを停止しない
    ```

3. **data_send_cycle (1バイト)**
    - モータードライバからのデータ送信周期を示すバイト。<br>
    - 範囲: `0x00` ～ `0xFF`

### 応答メッセージ

- **InitializationResponse** (`ID:0x011`)



## `MotorDrive` メッセージドキュメント

### 概要

`MotorDrive`は、duty比と方向によってモーターの駆動命令を伝えるためのメッセージです。
通常、50ms以下での送信周期が要求されます。<br>
このメッセージに対する応答メッセージはありません。

### メッセージID

- **CAN ID**: `0x020`

### メッセージ構造

```c
typedef struct {
    uint8_t md_id;       // モータードライバID
    uint16_t duty;       // モータードライブのデューティサイクル
    uint8_t direction;   // モーターの駆動方向
} MotorDrive;
```

### フィールド定義

1. **md_id (1バイト)**
    - モータードライバの固有ID。
    - 範囲: `0x00` ～ `0xFF`

2. **duty (12ビット)**
    - モーターの駆動強度を示すデューティサイクル。
    - 範囲: `0x000` ～ `0x0FAF` (0 ~ 3999)
    - 0にした場合、自動的にブレーキが掛かります。

3. **direction (1ビット)**
    - モーターの駆動方向。
        - `0`: 前進
        - `1`: 後進




## `StatusRequest` メッセージドキュメント

### 概要

`StatusRequest`は、モータードライバの現在の状態やパラメータを要求するためのメッセージです。
MDは全ての情報を送信します。

### メッセージID

- **CAN ID**: `0x030`

### メッセージ構造

```c
typedef struct {
    uint8_t md_id;  // モータードライバID
} StatusRequestToMD;
```

### 応答メッセージ

- **StatusResponse** (`ID:0x031`)




# MD送信メッセージ





## `StatusResponse` メッセージドキュメント

### 概要

`StatusResponse`は、モータードライバの現在の状態やパラメータを伝えるためのメッセージです。<br>
`StatusRequest`(ID:0x02A)の応答メッセージとして送信されます。

### メッセージID

- **CAN ID**: `0x031`

### メッセージ構造

```c
typedef struct {
    uint8_t md_id;           // モータードライバID
    uint8_t operation_mode;  // 現在の動作モード (3bit)
    int16_t temperature;     // 温度 (x10で小数点1桁の値を整数として扱う)
    int16_t current;         // 電流 (x10で小数点1桁の値を整数として扱う)
} StatusResponse;
```

### フィールド定義

1. **md_id (1バイト)**
    - 応答のモータードライバの固有ID。
    - 範囲: `0x00` ～ `0xFF`

2. **operation_mode (3bit)**
    - 現在の動作モードを示すコード。
    
3. **temperature (2バイト)**
    - モータードライバの現在の温度。
    - 範囲: `0` ～ `1200` (実際の温度の値 x 10)

4. **current (2バイト)**
    - モータードライバの現在の電流。
    - 範囲: `-1500` ～ `1500` (実際の電流の値 x 10)